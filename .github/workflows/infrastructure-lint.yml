name: Helm Chart Lint
permissions:
  contents: read
run-name: Linting ${{ github.event_name == 'workflow_dispatch' && (inputs.chart == 'all' && 'all charts' || inputs.chart) || 'changed files'}}

on:
  pull_request:
    branches: [main]
    paths: [openshift/**]
  workflow_dispatch:
    inputs:
      chart:
        description: "Select the chart to lint"
        required: true
        default: "all"
        type: choice
        options:
          - engagement-db
          - notify-api
          - met-api
          - met-web
          - analytics-api
          - met-analytics
          - locust
          - all
  workflow_call:
    inputs:
      chart:
        description: "Chart to lint (optional, defaults to changed files)"
        required: false
        type: string
        default: "auto"
      enable_server_lint:
        description: "Enable server-side linting (requires cluster access)"
        required: false
        type: boolean
        default: false
      environments:
        description: "Environment for server-side linting (dev, test, or prod)"
        required: false
        type: string
        default: "dev"

env:
  OC_VERSION: "4.16"

# Concurrency control to prevent simultaneous linting
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Setup job to determine charts and environments to lint
  setup:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.set-chart-matrix.outputs.charts }}
      environments: ${{ steps.set-env-matrix.outputs.environments }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history for changed-files detection

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@e0021407031f5be11a464abee9a0776171c79891 #v47.0.1
        with:
          files: |
            openshift/db/**
            openshift/notify/**
            openshift/api/**
            openshift/web/**
            openshift/analytics-api/**
            openshift/met-analytics/**
            openshift/dagster/**
            openshift/locust/**

      - name: Set matrix for changed charts
        id: set-chart-matrix
        run: |
          # Define chart directories
          declare -A chart_dirs=(
            [engagement-db]="openshift/db"
            [notify-api]="openshift/notify"
            [met-api]="openshift/api"
            [met-web]="openshift/web"
            [analytics-api]="openshift/analytics-api"
            [met-analytics]="openshift/met-analytics"
            [dagster]="openshift/dagster"
            [locust]="openshift/locust"
          )

          # Initialize charts array
          charts=()

          # Determine chart selection
          chart_input="${{ inputs.chart }}"
          if [[ "${{ github.event_name }}" == "workflow_call" && -n "$chart_input" && "$chart_input" != "auto" ]]; then
            # Workflow call with specific chart
            chart_name="$chart_input"
            charts+=("{\"name\":\"$chart_name\",\"dir\":\"${chart_dirs[$chart_name]}\"}")
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual workflow dispatch
            if [[ "${{ inputs.chart }}" != "all" ]]; then
              chart_name="${{ inputs.chart }}"
              charts+=("{\"name\":\"$chart_name\",\"dir\":\"${chart_dirs[$chart_name]}\"}")
            else
              # Add all charts
              for chart_name in "${!chart_dirs[@]}"; do
                charts+=("{\"name\":\"$chart_name\",\"dir\":\"${chart_dirs[$chart_name]}\"}")
              done
            fi
          else
            # Handle push or pull_request events - detect changed files
            changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
            
            # If no files changed in push event, lint all charts
            if [[ -z "$changed_files" && "${{ github.event_name }}" == "push" ]]; then
              for chart_name in "${!chart_dirs[@]}"; do
                charts+=("{\"name\":\"$chart_name\",\"dir\":\"${chart_dirs[$chart_name]}\"}")
              done
            else
              # Find changed charts
              for chart_name in "${!chart_dirs[@]}"; do
                if echo "$changed_files" | tr ' ' '\n' | grep -q "^${chart_dirs[$chart_name]}/"; then
                  charts+=("{\"name\":\"$chart_name\",\"dir\":\"${chart_dirs[$chart_name]}\"}")
                fi
              done
            fi
          fi

          # If no charts selected, skip the rest of the steps
          if [[ ${#charts[@]} -eq 0 ]]; then
            echo "No charts eligible for linting." >> $GITHUB_STEP_SUMMARY
            echo "charts=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Convert to JSON array
          charts_json=$(printf '%s\n' "${charts[@]}" | jq -s -c '.')

          echo "charts=${charts_json}" >> $GITHUB_OUTPUT
          echo -e "## Charts to lint: \n\n\`\`\`json\n$(echo $charts_json | jq)\n\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Set matrix for environments
        id: set-env-matrix
        run: |
          # Determine environments for linting
          if [[ "${{ inputs.enable_server_lint }}" == "true" ]]; then
            env_input="${{ inputs.environments }}"
            IFS=',' read -r -a env_array <<< "$env_input"
          else
            env_array=()
          fi
          # Convert to compact JSON array
          environments_json=$(printf '%s\n' "${env_array[@]}" | jq -R . | jq -s -c .)

          echo "environments=${environments_json}" >> $GITHUB_OUTPUT
          echo -e "## Environments to lint: \n\n\`\`\`json\n$(echo $environments_json | jq)\n\`\`\`" >> $GITHUB_STEP_SUMMARY

  lint:
    needs: setup
    runs-on: ubuntu-latest
    if: needs.setup.outputs.charts != '[]' && (needs.setup.outputs.environments != '[]' || inputs.enable_server_lint == false)
    environment: ${{ inputs.enable_server_lint && matrix.environment || null }}
    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJson(needs.setup.outputs.charts) }}
        environment: ${{ inputs.enable_server_lint && fromJson(needs.setup.outputs.environments) || fromJson('["none"]') }}
    concurrency:
      group: ${{ github.ref }}-${{ matrix.chart.name }}-lint
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install OpenShift CLI
        if: inputs.enable_server_lint == true
        uses: redhat-actions/openshift-tools-installer@144527c7d98999f2652264c048c7a9bd103f8a82 #v1.13.1
        with:
          oc: ${{ env.OC_VERSION }}
          skip_cache: true

      - name: Log in to OpenShift
        if: inputs.enable_server_lint == true
        uses: redhat-actions/oc-login@5eb45e848b168b6bf6b8fe7f1561003c12e3c99d #v1.3
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_LOGIN_REGISTRY }}
          openshift_token: ${{ secrets.OPENSHIFT_SA_TOKEN }}

      - name: Update Helm dependencies
        working-directory: "${{ matrix.chart.dir }}"
        run: |
          helm dependency update

      - name: Lint Helm chart
        working-directory: "${{ matrix.chart.dir }}"
        run: |
          # Determine validation method based on server-side linting flag
          if [[ "${{ inputs.enable_server_lint }}" == "true" ]]; then
            VALIDATION_METHOD="server"
            echo "Server-side linting enabled - using dry-run=server for environment: ${{ matrix.environment }}"
            
            # Lint the specific environment from the matrix
            echo "Linting for environment: ${{ matrix.environment }}"
            VALUES=""
            if [[ -f values_${{ matrix.environment }}.yaml ]]; then
              VALUES="--values values_${{ matrix.environment }}.yaml"
            fi
            
            helm lint . $VALUES
            helm template . $VALUES --dry-run=$VALIDATION_METHOD > /dev/null
          else
            VALIDATION_METHOD="client"
            echo "Server-side linting disabled - using dry-run=client for all environments"
            
            # Lint all environments with client-side validation
            for env in dev test prod; do
              echo "Linting for environment: $env"
              VALUES=""
              if [[ -f values_${env}.yaml ]]; then
                VALUES="--values values_${env}.yaml"
              fi
              
              helm lint . $VALUES
              helm template . $VALUES --dry-run=$VALIDATION_METHOD > /dev/null
            done
          fi
