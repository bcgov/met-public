# RoleBindings for the engagement-pipeline ServiceAccount
# Some magic to prevent us needing separate values files for each environment
{{- $namespaceParts := splitList "-" .Release.Namespace }}
{{- $environment := last $namespaceParts }}
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: 'engagement-pipeline-edit-binding'
  namespace: {{ .Release.Namespace }}
subjects:
  - kind: ServiceAccount
    name: 'engagement-pipeline'
    namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: edit
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: 'engagement-pipeline-role-view-binding'
  namespace: {{ .Release.Namespace }}
subjects:
  - kind: ServiceAccount
    name: 'engagement-pipeline'
    namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: engagement-pipeline
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: 'engagement-pipeline-{{ $environment }}-image-builder-binding'
  namespace: {{ .Values.app.licenseplate }}-tools
subjects:
  - kind: ServiceAccount
    name: 'engagement-pipeline'
    namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: 'system:image-builder'